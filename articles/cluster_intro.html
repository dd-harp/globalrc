<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Intro to Cluster • globalrc</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Intro to Cluster">
<meta property="og:description" content="How to login and run on the cluster.
">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">globalrc</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.0.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/cluster.html">Global Rc for Cluster</a>
    </li>
    <li>
      <a href="../articles/cluster_intro.html">Intro to Cluster</a>
    </li>
    <li>
      <a href="../articles/getstarted.html">Get Started</a>
    </li>
    <li>
      <a href="../articles/split_by_time_slice.html">Design to split by time slice</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/dd-harp/globalrc/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="cluster_intro_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Intro to Cluster</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/dd-harp/globalrc/blob/master/vignettes/cluster_intro.Rmd"><code>vignettes/cluster_intro.Rmd</code></a></small>
      <div class="hidden name"><code>cluster_intro.Rmd</code></div>

    </div>

    
    
<div id="run-ramp-analytics-on-the-cluster" class="section level1">
<h1 class="hasAnchor">
<a href="#run-ramp-analytics-on-the-cluster" class="anchor"></a>Run RAMP Analytics on the Cluster</h1>
<p>In order to run our code on the cluster, you have to get on the cluster, configure R, get the code, and work with the scheduler. Here are the steps.</p>
<div id="get-on-the-cluster" class="section level2">
<h2 class="hasAnchor">
<a href="#get-on-the-cluster" class="anchor"></a>Get on the cluster</h2>
<ol style="list-style-type: decimal">
<li>Connect to the cluster using Big-EDGE IP VPN.</li>
<li>SSH to the cluster.</li>
</ol>
<pre><code>ssh &lt;submit-node&gt;.uw.edu</code></pre>
<ol start="3" style="list-style-type: decimal">
<li>Login to a node. Type this. Wait. You will then be on a node where you can work.</li>
</ol>
<pre><code>qlogin -l h_rt=12:00:00,fthread=2,m_mem_free=4G -q i.q -P proj_mmc -now no</code></pre>
<p>If you have one qlogin session and want a second one, look up the hostname bu running the command <code>hostname</code> in the qlogin, do another ssh to the submit node, and ssh with</p>
<pre><code>ssh &lt;worker-node&gt;.uw.edu</code></pre>
<p>I’m telly you this because it’s hard to figure out the full hostname has five parts.</p>
</div>
<div id="set-up-r" class="section level2">
<h2 class="hasAnchor">
<a href="#set-up-r" class="anchor"></a>Set up R</h2>
<ol style="list-style-type: decimal">
<li>Put the code where Austin puts the code.</li>
</ol>
<pre><code>mkdir -p dev
cd dev
git clone git@github.com:dd-harp/analytics-pipeline.git
git clone git@github.com:dd-harp/pr2ar.git</code></pre>
<p>Check that R is cofigured. You configure R on the cluster by installing an Rprofile, like this one.</p>
<pre><code>$ cat ~.Rprofile
.libPaths(c("~/share/R3.6.2", .libPaths()))
options(repos = structure(c(CRAN = "https://repo.miserver.it.umich.edu/cran")))</code></pre>
<p>That tells R where to put its libraries when it runs.</p>
<p>Copy a script to run R. IHME provides a command to run R, but it doesn’t read the Rprofile. We hacked it to load the .Rprofile so that we can a) install our own external packages and b) use our code as packages. The three parts are</p>
<ul>
<li>
<code>~adolgert/bin/rsing</code> - command-line R</li>
<li>
<code>~adolgert/bin/execRscript.sh</code> - This runs a script as <code>execRscript.sh &lt;scriptname&gt;</code>.</li>
<li>
<code>~adolgert/bin/rsingbash</code> - A Bash command line within the R singularity image. This helps you figuure out what your script sees when it runs. For instance, <code>git</code> isn’t installed on the singularity image, so you can’t use <code>git</code>.</li>
</ul>
<p>So copy those if you need them.</p>
</div>
<div id="install-packages" class="section level2">
<h2 class="hasAnchor">
<a href="#install-packages" class="anchor"></a>Install packages</h2>
<pre><code>devtools::install("~/dev/pr2ar")</code></pre>
<p>If you’re re-installing pr2ar a million times because you’re editing it, try an alternative installation call.</p>
<pre><code>devtools::install("~/dev/pr2ar", dependencies = FALSE, upgrade = FALSE)</code></pre>
<p>If you see compilation messages like this, everything looks fine, but you might be in trouble.</p>
<pre><code>g++  -std=gnu++11 -I"/usr/local/lib/R/include" -DNDEBUG -I. -I/usr/local/include   -UDEBUG -DNDEBUG -DU_HAVE_ELF_H  -w -fno-gnu-unique -fno-optimize-sibling-calls -DMKL_ILP64 -m64 -I/opt/intel/compilers_and_libraries_2019.5.281/linux/mkl/include -I/usr/include                             -msse2 -mfpmath=sse -g -O3  -fPIC -fPIC   -w -fno-gnu-unique -fno-optimize-sibling-calls -DMKL_ILP64 -m64 -I/opt/intel/compilers_and_libraries_2019.5.281/linux/mkl/include -I/usr/include                             -msse2 -mfpmath=sse -g -O3   -c stri_trans_normalization.cpp -o stri_trans_normalization.o</code></pre>
<p>The problem is that the sse and sse2 optimizations may work on one computer but not another. If you later see an error called “illegal instruction,” then you have to go back and install every package with optimization turned off. This means that R’s install won’t work by default. You need to customize installation for failing packages. And maybe tell Infra that you’d like a cluster that uses the same processors for all of the nodes.</p>
<p>Test that it loads with <code><a href="https://rdrr.io/r/base/library.html">library(pr2ar)</a></code>.</p>
</div>
<div id="run-rstudio" class="section level2">
<h2 class="hasAnchor">
<a href="#run-rstudio" class="anchor"></a>Run RStudio</h2>
<p>Go the Hub and search for “R/RStudio Cluster Cheat Sheet”. Or try this link: <a href="https://hub.ihme.washington.edu/pages/viewpage.action?pageId=60485097" class="uri">https://hub.ihme.washington.edu/pages/viewpage.action?pageId=60485097</a></p>
<p>Then run</p>
<pre><code>singRstudio -P proj_mmc</code></pre>
<p>You’ll see something like this, where the last line tells you where to point your web browser.</p>
<pre><code>$ singRstudio -P proj_mmc
--------------------------------------------------------------------------------
RStudio Qsub Script Info
----------------------------------------
Script Name             : 'rstudio_qsub_script'
Version                 : 2.0.1

Number of threads set to: 2 (default)
Maximum memory set to   : '1G' (default)
Queue set to            : 'all.q' (default)
Runtime set to          : '03:00:00:00' (default)
Cluster set to          : 'prod' (default)
Project set to          : 'proj_mmc'
Port set to             : '7285' (based on user name)
Image type              : LBD Team (default)
Image version set to    : /share/singularity-images/lbd/rstudio/shells/lbd_rstudio_shells/rstudio_shell_9999_current.sh
Requesting archive nodes: TRUE (default)

Submitting RStudio job with the following command:
'qsub -N rstudio_ide -j y -o /share/temp/sgeoutput/adolgert/output -now no -P proj_mmc -l fthread=2 -l m_mem_free=1G -l h_rt=03:00:00:00 -q all.q  -l archive=TRUE  /share/singularity-images/lbd/rstudio/shells/lbd_rstudio_shells/rstudio_shell_9999_current.sh 7285'
Your job 40923023 ("rstudio_ide") has been submitted
http://gen-uge-archive-p207.cluster.ihme.washington.edu:7285</code></pre>
<p>That last line is a URL. Point your web browser there, and you’ll see R.</p>
<p>Is it pointing to your installed libraries? Check for your library with</p>
<pre><code><a href="https://rdrr.io/r/base/libPaths.html">.libPaths()</a></code></pre>
<p>I had a problem with the versions not matching, so I ran this to make them match.</p>
<pre><code><a href="https://rdrr.io/r/base/libPaths.html">.libPaths(c("/ihme/homes/adolgert/share/R3.6.1", "/usr/local/R-3.6.1/library"))</a></code></pre>
<p>I finally found the post that leads to how you run Rstudio on the cluster using the Scicomp version:</p>
<pre><code>Hi, RStudio singularity users, we just released 3.6.0.2 with bug fixes and new packages. Here is the release note: https://hub.ihme.washington.edu/pages/viewpage.action?spaceKey=DataScience&amp;title=GBD+Rstudio+Singularity+Image+Release+Note. Since it's still in beta, the default image is still 3.6.0.1. If you want to use this image, please specify -i /ihme/singularity-images/rstudio/ihme_rstudio_3602-beta.img on your command. Example:

sh /ihme/singularity-images/rstudio/shells/jpy_rstudio_qsub_script.sh -i /ihme/singularity-images/rstudio/ihme_rstudio_3602-beta.img -t rstudio -P proj_burdenator -G w</code></pre>
<p>Maybe that helps. The previous instructions are for using the geospatial version because they have instructions.</p>
</div>
<div id="fixing-permission-problems" class="section level2">
<h2 class="hasAnchor">
<a href="#fixing-permission-problems" class="anchor"></a>Fixing Permission Problems</h2>
<p>Sometimes the permissions aren’t right. These are commands that fix them. Note that the ihme-malaria group id is 700187</p>
<pre><code>cd /ihme/malaria_modeling
find . -type d -user adolgert -group "Domain Users" -exec chown adolgert:ihme-malaria {} \;
find . -type f -user adolgert -group "Domain Users" -exec chown adolgert:ihme-malaria {} \;
find . -user adolgert -exec chmod ug+rwX {} \;</code></pre>
</div>
<div id="running-jobs" class="section level2">
<h2 class="hasAnchor">
<a href="#running-jobs" class="anchor"></a>Running jobs</h2>
<p>Modify the <code>out_dir</code> in the gen_scaled_ar.R script so that it writes to a new location.</p>
<p>Get the qsub string by running a script to print it.</p>
<pre><code>execRscript.sh print_launch.R</code></pre>
<p>Then copy the qsub string and paste it into the command line. It will be something like this.</p>
<pre><code>qsub -l m_mem_free=2.0G -l fthread=1 -l h_rt=24:00:00 -l archive=True -q all.q -cwd -P proj_mmc -e /share/temp/sgeoutput/adolgert/errors -o /share/temp/sgeoutput/adolgert/output -N gen_scaled_ar -t 1:13500 /homes/adolgert/bin/execRscript.sh /homes/adolgert//dev/analytics-pipeline/gen_scaled_ar/gen_scaled_ar.R</code></pre>
<p>It isn’t running from inside R because <code>SGE_ROOT</code> is defined as <code>/opt/sge</code> which isn’t in the singularity image. Whatever. Run the command from the command line. Look at the job ID that’s returned. Use <code>qstat</code> to see the jobs running. When they are done, use <code>qacct -j &lt;jobid&gt; | grep exit_status | uniq</code> to see if they are all exit status 0.</p>
<p>The files should be in <code>out_dir</code> from gen_scaled_ar.R, which is currently set to <code>/ihme/malaria_modeling/projects/uganda2020/outputs/practice_draws/</code>. See that they were made and have the right owner and group and privileges, like this, so ihme-malaria owns them and they are rw for owner and group.</p>
<pre><code>-rw-rw-r-- 1 adolgert ihme-malaria 6619 May  2 18:13 1_1.csv</code></pre>
<p>Combine the output results by running another script. Edit this script first so that it knows where to put its outputs without overwriting.</p>
<pre><code>execRscript.sh combine_pr_files.R</code></pre>
<p>Do you want to know how long it took to run jobs? After they are finished, run</p>
<pre><code>qacct -j gen_scaled_ar | grep ^wallclock | cut -d' ' -f5</code></pre>
<p>This gives seconds for each run. It is about 2 hours currently, per draw.</p>
</div>
<div id="data-and-plots" class="section level2">
<h2 class="hasAnchor">
<a href="#data-and-plots" class="anchor"></a>Data and Plots</h2>
<p>The combined files are in a directory on the cluster, determined by the <code>combine_pr_files.R</code> script. You can leave them there or zip and transfer them, but go into the <code>plot</code> subdirectory to find <code>make_maps.Rmd</code> in order to make maps from those plots. You’ll point a variable there at the location of the files.</p>
</div>
<div id="rstudio" class="section level2">
<h2 class="hasAnchor">
<a href="#rstudio" class="anchor"></a>RStudio</h2>
<p>If you want to run under Rstudio on the cluster, then create a ~/.Rprofile script and <code>export R_PROFILE=$HOME/.Rprofile</code> in your .bashrc. That script should point to a library path that matches the current version of R in R singularity. That’s <code>~/share/R3.6.3</code> right now.</p>
<p>Run Rstudio with this qsub for 2 threads, 10GB of memory 12 hours, interactive queue. Yes, they changed the specifications from the way qsub handles them. Read the instructions and then try a bunch of times until it works.</p>
<pre><code>/ihme/singularity-images/rstudio/shells/jpy_rstudio_qsub_script.sh -t rstudio -i /ihme/singularity-images/rstudio/ihme_rstudio_3630.img -f 2 -o 2 -m 10G -h 12 -P proj_mmc -q i -l /share/temp/sgeoutput/$USER/errors</code></pre>
<p>When you run qsub, it will tell you the port number it will try to give you, although that can fail, of course. But then you qstat, which might look like this:</p>
<pre><code>$ qstat
job-ID     prior   name       user         state submit/start at     queue                          jclass                         slots ja-task-ID 
------------------------------------------------------------------------------------------------------------------------------------------------
  41622257 0.50026 QLOGIN     adolgert     r     05/10/2020 16:46:07 i.q@int-uge-archive-p005.clust                                    1        
  41624723 0.50023 rst_ide_20 adolgert     r     05/10/2020 17:12:22 i.q@int-uge-archive-p004.clust                                    1        
</code></pre>
<p>That tells me to connect my web browser to int-uge-archive-p004.cluster.ihme.washington.edu:6232, because that’s the port number associated with my name. It may be someone else’s too, but whatever.</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Andrew Dolgert, Dave Smith.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
