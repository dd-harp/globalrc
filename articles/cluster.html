<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Global Rc for Cluster • globalrc</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Global Rc for Cluster">
<meta property="og:description" content="How to run Global Rc on the cluster.
">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">globalrc</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/cluster.html">Global Rc for Cluster</a>
    </li>
    <li>
      <a href="../articles/cluster_intro.html">Intro to Cluster</a>
    </li>
    <li>
      <a href="../articles/getstarted.html">Get Started</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/dd-harp/globalrc/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="cluster_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Global Rc for Cluster</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/dd-harp/globalrc/blob/master/vignettes/cluster.Rmd"><code>vignettes/cluster.Rmd</code></a></small>
      <div class="hidden name"><code>cluster.Rmd</code></div>

    </div>

    
    
<div id="running-rc_kappa" class="section level1">
<h1 class="hasAnchor">
<a href="#running-rc_kappa" class="anchor"></a>Running rc_kappa</h1>
<div id="introduction" class="section level2">
<h2 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h2>
<p>This is how to run the <code>rc_kappa</code> code. There are two ways this code runs, in parallel on a single computer, and distributed on the cluster.</p>
</div>
<div id="whats-in-the-package" class="section level2">
<h2 class="hasAnchor">
<a href="#whats-in-the-package" class="anchor"></a>What’s in the package</h2>
<div id="shell-scripts" class="section level3">
<h3 class="hasAnchor">
<a href="#shell-scripts" class="anchor"></a>Shell Scripts</h3>
</div>
<div id="r-main-scripts-and-shell-scripts" class="section level3">
<h3 class="hasAnchor">
<a href="#r-main-scripts-and-shell-scripts" class="anchor"></a>R main scripts and shell scripts</h3>
<ul>
<li>
<code>rc_kappa.sh</code> - A shell script to qsub the single-machine version of the code. This was failing on the cluster because R’s fork-cluster would get a SIGPIPE singal.</li>
<li>
<code>rc_worker.sh</code> - A shell script to qsub for distributed runs.</li>
<li>
<code>rc_kappa_run.R</code> - A main() to run the single-machine version of the code.</li>
<li>
<code>rc_run_plan.R</code> - A main() to run the first distributed step.</li>
<li>
<code>rc_run_worker.R</code> - What runs in tasks for the main distributed step.</li>
<li>
<code>rc_run_assemble.R</code> - A main() to run the distributed assembly step.</li>
</ul>
</div>
<div id="code" class="section level3">
<h3 class="hasAnchor">
<a href="#code" class="anchor"></a>Code</h3>
<ul>
<li>
<code>rc_kappa.R</code> - The main file with most of the code.</li>
<li>
<code>serialize.R</code> - Saves and loads HDF chunks of data, for each tile.</li>
<li>
<code>plan_io.R</code> - Saves and loads the plan to decompose the data for parallel computation.</li>
<li>
<code>hilbert.R</code> - Orders tiles so that nearby tiles are nearby in a linear list.</li>
<li>
<code>test-*.R</code> - Testing files for the code.</li>
</ul>
</div>
<div id="science" class="section level3">
<h3 class="hasAnchor">
<a href="#science" class="anchor"></a>Science</h3>
<ul>
<li>
<code>rc_kappa.Rmd</code> - A vignette to look at the per-pixel function that decides the numbers. All the science is here.</li>
<li>
<code>rc_kappa.toml</code> - Parameters for the run.</li>
<li>
<code>rc_sensitivity.jl</code> - Calculates Jacobian of the pixel work and does Bayesian inference on it.</li>
</ul>
</div>
</div>
<div id="running-distributed-on-the-cluster" class="section level2">
<h2 class="hasAnchor">
<a href="#running-distributed-on-the-cluster" class="anchor"></a>Running distributed on the cluster</h2>
<p>There is some introductory information for using the cluster in <code>run_ramp.md</code>. For <code>rc_kappa</code>, in particular, there are three steps.</p>
<ol style="list-style-type: decimal">
<li>Create a plan.</li>
<li>Run workers to compute that plan.</li>
<li>Assemble the results from the workers.</li>
</ol>
<p>All three steps take the same command line, but they have different scripts.</p>
<div id="create-a-plan-" class="section level3">
<h3 class="hasAnchor">
<a href="#create-a-plan-" class="anchor"></a>Create a plan.</h3>
<p>The first script is <code>rc_run_plan.R</code>.</p>
<ul>
<li>
<code>--config=rc_kappa.toml</code> This one uses parameters from the <code>rc_kappa.toml</code> configuration file.</li>
<li>
<code>--years=2000:2019</code> You have to give it a years argument, and that argument must be at least two years, for instance, 2017:2018.</li>
<li>
<code>--draws=100</code> The draws can be 1, in which case it uses mean values.</li>
<li>
<code>--tasks=100</code> Not used for this step, but I like to keep the arguments consistent. This doesn’t match draws in any way. It’s the number of SGE jobs we will run.</li>
<li>
<code>--outvars=201121_split100</code> This is the output directory. It will be: <code>/ihme/malaria_modeling/projects/globalrc/outputs/basicr/201121_split100</code>.</li>
</ul>
<pre><code>/ihme/singularity-images/rstudio/shells/execRscript.sh -i /ihme/singularity-images/rstudio/ihme_rstudio_4030.img -s rc_run_plan.R --config=rc_kappa.toml --outvars=201121_split100 --years=2000:2019 --draws=100 --tasks=100</code></pre>
<p>This step is quick to run. I do it interactively. It creates two files in the <code>outvars</code> directory:</p>
<ul>
<li>
<code>plan.json</code> - This is the extent of the map to process and information about the blocksize and coordinates in lat-long.</li>
<li>
<code>work.csv</code> - This is a list of tiles which have a nonzero PfPR value, where a tile is a 32x32 set of pixels in each image. The blocksize is set in the <code>rc_kappa.toml</code> file.</li>
</ul>
</div>
<div id="run-workers-on-that-plan" class="section level3">
<h3 class="hasAnchor">
<a href="#run-workers-on-that-plan" class="anchor"></a>Run workers on that plan</h3>
<p>The worker runs under SGE. The shell script to qsub, with <code>qsub rc_worker.sh</code>, is set up to handle both the initial run and rerunning any task that failed to complete. In it, you’ll see these choices.</p>
<ul>
<li>
<code>-cwd</code> - Start the process in the same directory as the one in which I invoke the <code>qsub rc_worker.sh</code>.</li>
<li>
<code>fthread=2</code> - Each R process takes one thread, but it can be helpful to allow another thread because I/O can take its own thread sometimes.</li>
<li>
<code>-o /share/temp/sgeoutput...</code> - This says that each task gets its own output file, containing both output and error, because of the <code>-y</code> argument.</li>
<li>
<code>-t 1-100</code> - This tells the scheduler to run 100 copies of this script as what the scheduler calls tasks. Each task has its own <code>SGE_TASK_ID</code> set to its index in the 100, starting from 1, going to 100. Each time the R code runs, it checks the <code>SGE_TASK_ID</code> environment variable in order to figure out its task.</li>
<li>
<code>-q all.q</code> - This is the general queue. Works fine.</li>
<li>
<code>-l h_rt=3:00:00</code> - Allow three hours to run. One hour was too litte, and sometimes I/O can be terribly much slower than normal, so leave room, but not 72 hours, because they it won’t get scheduled soon.</li>
<li>
<code>-l m_mem_free=4G</code> - Request 4GB of RAM. This seems to need about 2GB.</li>
</ul>
<p>This worker took over an hour for 9 tiles per worker for 100 draws. That means 1 tile for 1000 draws could be 2 hours.</p>
<p>If I haven’t run this script on a given number of draws, I run it first for tasks <code>-t 100-100</code>, and record its job id, in order to see how long it takes and how much memory it needs. These are in <code>qacct -j &lt;job_id&gt;</code> as RSS (in kb) and wallclock time. Another way, easier, is to run the comman interactively, prefixed by <code>/usr/bin/time --verbose</code> and adding <code>--task=1</code> at the end. This will both the real time and the maximum resident set size, in kilobytes. Divide by 1024^2 to get GB for the qsub command. It should be near 1-4 GB.</p>
<pre><code>#!/bin/sh
#$ -P proj_mmc
#$ -cwd
#$ -j y
#$ -o /share/temp/sgeoutput/adolgert/rc_kappa_$JOB_ID_$TASK_ID.txt
#$ -N rc_split
#$ -l fthread=2
#$ -t 1-100
#$ -q all.q
#$ -l h_rt=3:00:00
#$ -l m_mem_free=4G
#$ -S /bin/bash

# If there were tasks that didn't run, paste their numbers here.
# This way you can submit one job that works through the missing ones.
# MISSING=40,44,47,49,50,52
MISSING=
if [[ -n "${MISSING}" ]]
then
  export SGE_TASK_ID=`echo $MISSING | cut -d"," -f"${SGE_TASK_ID}"`
fi

VERSION=201121_split100
/ihme/singularity-images/rstudio/shells/execRscript.sh \
  -i /ihme/singularity-images/rstudio/ihme_rstudio_4030.img \
  -s rc_run_worker.R --config=rc_kappa.toml --outvars=${VERSION} \
  --years=2000:2019 --tasks=100 --draws=100</code></pre>
<p>The <code>MISSING</code> lines are there in case any tasks fail. This is a common problem on this cluster. You’ll see that the next step, to assemble the data, will report missing tasks to the command line. You can copy those values here. Then, if there are 6 missing, change the tasks to go from <code>-t 1-6</code>, and, instead of executing the 1st-6th tasks, it will do the missing ones.</p>
<p>These runs generate one HDF5 file for each worker, in the same outvars directory as above.</p>
</div>
<div id="assemble-output-from-workers" class="section level3">
<h3 class="hasAnchor">
<a href="#assemble-output-from-workers" class="anchor"></a>Assemble output from workers</h3>
<p>Finally, we read all of the HDF5 files and create GeoTIFFs, one for each variable, for each median and confidence interval, for each year.</p>
<p>The <code>rc_run_assemble.R</code> script takes the same arguments as those above. If this script doesn’t find all of its inputs, it will list those that are missing and print the missing tasks in a format suitable to place in the <code>MISSING</code> variable in the qsub script above. If you know some jobs failed, running this is any easy way to find the failures.</p>
<p>This script takes about 3GB to read data from 100 files. It works by variable, so the memory usage is low. It would be possible to run this in parallel over the variables. Takes about 20 mins now.</p>
<pre><code>/ihme/singularity-images/rstudio/shells/execRscript.sh -i /ihme/singularity-images/rstudio/ihme_rstudio_4030.img -s  rc_run_assemble.R --config=rc_kappa.toml --outvars=201121_split100 --years=2000:2019 --draws=100 --tasks=100</code></pre>
<p>The workers can run in parallel with GNU parallel. You use the task ID to say which variable this worker will save. There are currently 18 variables, but may change.</p>
<pre><code>parallel Rscript scripts/rc_run_assemble.R --config=scripts/sam_mean.toml   --outvars=201124_africa_mean --years=2017:2017 --draws=100 --tasks=217 --overwrite --task={} ::: {1..18}</code></pre>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Andrew Dolgert, Dave Smith.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
